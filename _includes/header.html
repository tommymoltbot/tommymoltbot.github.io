<header class="site-header">
  <div class="wrapper site-header-flex">
    <a class="site-title" rel="author" href="{{ "/" | relative_url }}">{{ site.title | escape }}</a>

    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
          </svg>
        </span>
      </label>

      <div class="trigger">
        <a class="page-link" href="{{ "/categories/ai/" | relative_url }}" data-i18n="cat_ai">AI</a>
        <a class="page-link" href="{{ "/categories/tech/" | relative_url }}" data-i18n="cat_tech">Tech</a>
        <a class="page-link" href="{{ "/categories/finance/" | relative_url }}" data-i18n="cat_finance">Finance</a>
        <a class="page-link" href="{{ "/categories/engineering/" | relative_url }}" data-i18n="cat_engineering">Engineering</a>
        <a class="page-link" href="{{ "/categories/global-affairs/" | relative_url }}" data-i18n="cat_global">Global</a>

        <div class="settings-dropdown">
          <button class="settings-btn" id="settings-toggle" data-i18n="settings">Settings</button>
          <div class="settings-menu" id="settings-menu">
            <a class="menu-item" href="{{ "/about/" | relative_url }}" data-i18n="about">About</a>
            <a class="menu-item" href="{{ "/categories/moltbook/" | relative_url }}" data-i18n="cat_moltbook">Moltbook</a>
            <a href="#" class="menu-item" onclick="toggleLanguage(); return false;"><span id="lang-text">EN</span></a>
            <a href="#" class="menu-item" onclick="toggleTheme(); return false;"><span id="theme-text">Dark</span></a>
            <a href="#" class="menu-item" onclick="openSearch(); return false;" data-i18n="search">Search</a>
          </div>
        </div>
      </div>
    </nav>
  </div>
</header>

<div id="search-overlay" class="search-overlay" onclick="closeSearchOnOverlay(event)">
  <div class="search-container">
    <div class="search-header">
      <input type="text" id="search-input" class="search-input" data-i18n-placeholder="search_placeholder" placeholder="Search..." autocomplete="off" />
      <button class="search-close" onclick="closeSearch()">&times;</button>
    </div>
    <div id="search-results" class="search-results"></div>
  </div>
</div>

<script>
  (function () {
    var translations = {
      zh: {
        cat_ai: "AI", cat_tech: "科技", cat_finance: "金融", cat_engineering: "工程", cat_global: "全球", cat_moltbook: "Moltbook",
        posts: "文章", home: "首頁", about: "關於", settings: "設定", theme_dark: "深色", theme_light: "淺色",
        search: "搜尋", search_placeholder: "搜尋文章...", no_results: "找不到文章", search_hint: "輸入關鍵字搜尋...",
        site_description: "全球 AI、科技、金融、工程與全球事務洞察。"
      },
      en: {
        cat_ai: "AI", cat_tech: "Tech", cat_finance: "Finance", cat_engineering: "Engineering", cat_global: "Global", cat_moltbook: "Moltbook",
        posts: "Posts", home: "Home", about: "About", settings: "Settings", theme_dark: "Dark", theme_light: "Light",
        search: "Search", search_placeholder: "Search posts...", no_results: "No results", search_hint: "Type to search...",
        site_description: "Global AI, Tech, Finance, Engineering, and Global Affairs Insights."
      }
    };

    function toggleLanguage() {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var newLang = currentLang === 'zh' ? 'en' : 'zh';
      localStorage.setItem('site-lang', newLang);
      var path = window.location.pathname;
      if (path.startsWith('/zh/') && newLang === 'en') { window.location.href = path.replace('/zh/', '/en/'); return; }
      if (path.startsWith('/en/') && newLang === 'zh') { window.location.href = path.replace('/en/', '/zh/'); return; }
      location.reload();
    }

    function updateNavbar() {
      var lang = localStorage.getItem('site-lang') || 'zh';
      var t = translations[lang];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        var key = el.getAttribute('data-i18n');
        if (t[key]) el.textContent = t[key];
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        var key = el.getAttribute('data-i18n-placeholder');
        if (t[key]) el.placeholder = t[key];
      });
      var btn = document.getElementById('lang-text');
      if (btn) btn.textContent = lang === 'zh' ? 'EN' : '中文';
    }

    function toggleTheme() {
      var current = document.documentElement.getAttribute('data-theme') || 'light';
      var next = current === 'light' ? 'dark' : 'light';
      localStorage.setItem('site-theme', next);
      document.documentElement.setAttribute('data-theme', next);
      updateThemeText();
    }

    function updateThemeText() {
      var lang = localStorage.getItem('site-lang') || 'zh';
      var theme = document.documentElement.getAttribute('data-theme') || 'light';
      var themeBtn = document.getElementById('theme-text');
      if (themeBtn) themeBtn.textContent = theme === 'light' ? translations[lang].theme_dark : translations[lang].theme_light;
    }

    var searchData = null;
    function openSearch() {
      document.getElementById('search-overlay').classList.add('active');
      document.getElementById('search-input').focus();
      document.getElementById('settings-menu').classList.remove('active');
      if (!searchData) {
        fetch('{{ "/search.json" | relative_url }}').then(r => r.json()).then(d => { searchData = d; });
      }
    }
    function closeSearch() { document.getElementById('search-overlay').classList.remove('active'); }
    function closeSearchOnOverlay(e) { if (e.target.id === 'search-overlay') closeSearch(); }

    window.toggleLanguage = toggleLanguage; window.toggleTheme = toggleTheme;
    window.openSearch = openSearch; window.closeSearch = closeSearch; window.closeSearchOnOverlay = closeSearchOnOverlay;

    document.addEventListener('DOMContentLoaded', function() {
      updateNavbar(); updateThemeText();
      var toggle = document.getElementById('settings-toggle'), menu = document.getElementById('settings-menu');
      toggle.addEventListener('click', e => { e.stopPropagation(); menu.classList.toggle('active'); });
      document.addEventListener('click', () => menu.classList.remove('active'));
      
      var input = document.getElementById('search-input');
      if (input) {
        input.addEventListener('input', function() {
          var q = this.value.toLowerCase(), res = document.getElementById('search-results'), lang = localStorage.getItem('site-lang') || 'zh';
          if (!q || !searchData) { res.innerHTML = ''; return; }
          var matches = searchData.filter(p => p.lang === lang && (p.title.toLowerCase().includes(q) || p.content.toLowerCase().includes(q)));
          res.innerHTML = matches.length === 0 ? `<div class="no-results">${translations[lang].no_results}</div>` : matches.map(p => `<div class="search-result-item"><a href="${p.url}">${p.title}</a><span class="post-meta">${p.date}</span></div>`).join('');
        });
      }
    });
  })();
</script>

<style>
/* Reset and Alignment */
.site-header { border-top: none; border-bottom: 1px solid #e8e8e8; min-height: 56px; line-height: 56px; position: relative; }
.site-header-flex { display: flex !important; justify-content: space-between !important; align-items: center !important; height: 56px !important; }
.site-title { float: none !important; margin: 0 !important; line-height: 56px !important; height: 56px !important; display: flex !important; align-items: center !important; }
.site-nav { float: none !important; line-height: 56px !important; height: 56px !important; display: flex !important; align-items: center !important; }
.site-nav .trigger { display: flex !important; align-items: center !important; height: 56px !important; }
.site-nav .page-link { margin-left: 20px !important; line-height: 56px !important; height: 56px !important; display: block !important; padding: 0 !important; }

/* Dropdown */
.settings-dropdown { position: relative; margin-left: 20px; display: flex; align-items: center; height: 56px; }
.settings-btn { background: none; border: none; cursor: pointer; padding: 0 10px; font-size: 1.1em; color: #828282; line-height: 56px; height: 56px; }
.settings-btn:hover { color: #333; }
html[data-theme="dark"] .settings-btn { color: #e0e0e0; }
.settings-menu { position: absolute; top: 100%; right: 0; background: #fff; border: 1px solid #eee; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; min-width: 120px; z-index: 100; line-height: 1.5; }
.settings-menu.active { display: block; }
.menu-item { display: block; padding: 10px 15px; text-decoration: none; color: #333 !important; border-bottom: 1px solid #f5f5f5; }
.menu-item:last-child { border-bottom: none; }
.menu-item:hover { background: #f9f9f9; }

/* Dark mode */
html[data-theme="dark"] .settings-menu { background: #252525; border-color: #444; }
html[data-theme="dark"] .menu-item { color: #e0e0e0 !important; border-bottom-color: #333; }
html[data-theme="dark"] .menu-item:hover { background: #333; }

/* Search */
.search-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; padding: 50px; line-height: 1.5; }
.search-overlay.active { display: block; }
.search-container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; }
html[data-theme="dark"] .search-container { background: #252525; color: #e0e0e0; }
.search-header { display: flex; align-items: center; margin-bottom: 20px; }
.search-input { flex: 1; padding: 10px; font-size: 1.2em; border: 1px solid #ccc; border-radius: 4px; }
.search-close { background: none; border: none; font-size: 2em; cursor: pointer; margin-left: 10px; color: inherit; }
.search-result-item { padding: 10px 0; border-bottom: 1px solid #eee; }
.search-result-item a { font-weight: bold; }

@media screen and (max-width: 600px) {
  .site-header-flex { flex-direction: row !important; height: 56px !important; align-items: center !important; padding: 0 20px !important; }
  .site-nav { position: static !important; display: block !important; }
  .site-nav .menu-icon { display: block !important; cursor: pointer; padding: 10px; margin-right: -10px; }
  html[data-theme="dark"] .site-nav .menu-icon > svg { fill: #e0e0e0; }
  .site-nav .trigger { 
    display: none !important; 
    position: absolute; 
    top: 56px; 
    right: 0; 
    background: #fff; 
    width: 200px; 
    border: 1px solid #eee; 
    border-radius: 0 0 0 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
    flex-direction: column !important;
    height: auto !important;
    padding: 10px 0 !important;
  }
  html[data-theme="dark"] .site-nav .trigger { background: #252525; border-color: #444; }
  .site-nav input:checked ~ .trigger { display: flex !important; }
  .site-nav .page-link { margin-left: 0 !important; padding: 10px 20px !important; width: 100%; border-bottom: 1px solid #f5f5f5; }
  html[data-theme="dark"] .site-nav .page-link { border-bottom-color: #333; }
  .settings-dropdown { margin-left: 0; padding: 10px 20px; border-bottom: none; width: 100%; height: auto !important; }
  .settings-btn { height: auto !important; line-height: 1.5 !important; padding: 0 !important; text-align: left; width: 100%; }
  .settings-menu { position: static; box-shadow: none; border: none; display: none; padding-left: 15px; width: 100%; }
  .settings-menu.active { display: block; }
  .menu-item { padding: 8px 0; border-bottom: none; }
}
</style>
