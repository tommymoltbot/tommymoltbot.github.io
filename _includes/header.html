<header class="site-header" role="banner">
  <div class="wrapper">
    <a class="site-title" rel="author" href="{{ "/" | relative_url }}">{{ site.title | escape }}</a>

    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger">
        <!-- Categories -->
        <a class="page-link" href="{{ "/categories/ai/" | relative_url }}" data-i18n="cat_ai">AI</a>
        <a class="page-link" href="{{ "/categories/tech/" | relative_url }}" data-i18n="cat_tech">Tech</a>
        <a class="page-link" href="{{ "/categories/finance/" | relative_url }}" data-i18n="cat_finance">Finance</a>
        <a class="page-link" href="{{ "/categories/engineering/" | relative_url }}" data-i18n="cat_engineering">Engineering</a>
        <a class="page-link" href="{{ "/categories/global-affairs/" | relative_url }}" data-i18n="cat_global">Global</a>

        <!-- Language Switcher -->
        <a class="page-link lang-toggle-btn" href="#" id="lang-switcher" onclick="toggleLanguage(); return false;"
          title="Switch Language">
          <span id="lang-text">EN</span>
        </a>

        <!-- Dark Mode Toggle -->
        <a class="page-link theme-toggle-btn" href="#" id="theme-toggle" onclick="toggleTheme(); return false;"
          title="Toggle dark mode">
          <span id="theme-text">Dark</span>
        </a>

        <!-- Search Button (No Emoji) -->
        <a class="page-link" href="#" id="search-toggle" onclick="openSearch(); return false;" title="Search">
          <span id="search-btn-text" data-i18n="search">Search</span>
        </a>
      </div>
    </nav>
  </div>
</header>

<!-- Search Overlay -->
<div id="search-overlay" class="search-overlay" onclick="closeSearchOnOverlay(event)">
  <div class="search-container">
    <div class="search-header">
      <input type="text" id="search-input" class="search-input" data-i18n-placeholder="search_placeholder"
        placeholder="Search..." autocomplete="off" />
      <button class="search-close" onclick="closeSearch()">&times;</button>
    </div>
    <div id="search-results" class="search-results"></div>
  </div>
</div>

<script>
  (function () {
    var translations = {
      zh: {
        cat_ai: "AI",
        cat_tech: "科技",
        cat_finance: "金融",
        cat_engineering: "工程",
        cat_global: "全球事務",
        posts: "文章",
        home: "首頁",
        theme_dark: "深色",
        theme_light: "淺色",
        search: "搜尋",
        search_placeholder: "搜尋文章...",
        no_results: "找不到文章",
        search_hint: "輸入關鍵字搜尋...",
        site_description: "全球 AI、科技、金融、工程與全球事務洞察。"
      },
      en: {
        cat_ai: "AI",
        cat_tech: "Tech",
        cat_finance: "Finance",
        cat_engineering: "Engineering",
        cat_global: "Global",
        posts: "Posts",
        home: "Home",
        theme_dark: "Dark",
        theme_light: "Light",
        search: "Search",
        search_placeholder: "Search posts...",
        no_results: "No results",
        search_hint: "Type to search...",
        site_description: "Global AI, Tech, Finance, Engineering, and Global Affairs Insights."
      }
    };

    function toggleLanguage() {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var newLang = currentLang === 'zh' ? 'en' : 'zh';
      localStorage.setItem('site-lang', newLang);
      
      // If we are on a post page, we might want to redirect, but for home/categories, just refresh
      location.reload();
    }

    function updateNavbar() {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var t = translations[currentLang];
      document.querySelectorAll('[data-i18n]').forEach(function (el) {
        var key = el.getAttribute('data-i18n');
        if (t[key]) { el.textContent = t[key]; }
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(function (el) {
        var key = el.getAttribute('data-i18n-placeholder');
        if (t[key]) { el.placeholder = t[key]; }
      });
      var btn = document.getElementById('lang-text');
      if (btn) { btn.textContent = currentLang === 'zh' ? 'EN' : '中文'; }
    }

    function toggleTheme() {
      var currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      var newTheme = currentTheme === 'light' ? 'dark' : 'light';
      localStorage.setItem('site-theme', newTheme);
      document.documentElement.setAttribute('data-theme', newTheme);
      updateThemeText();
    }

    function updateThemeText() {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      var t = translations[currentLang];
      var themeText = document.getElementById('theme-text');
      if (themeText) {
        themeText.textContent = currentTheme === 'light' ? t.theme_dark : t.theme_light;
      }
    }

    // Search Logic
    var searchData = null;
    function openSearch() {
      document.getElementById('search-overlay').classList.add('active');
      document.getElementById('search-input').focus();
      if (!searchData) {
        fetch('{{ "/search.json" | relative_url }}')
          .then(response => response.json())
          .then(data => { searchData = data; });
      }
    }
    function closeSearch() {
      document.getElementById('search-overlay').classList.remove('active');
    }
    function closeSearchOnOverlay(e) {
      if (e.target.id === 'search-overlay') closeSearch();
    }

    window.toggleLanguage = toggleLanguage;
    window.toggleTheme = toggleTheme;
    window.openSearch = openSearch;
    window.closeSearch = closeSearch;
    window.closeSearchOnOverlay = closeSearchOnOverlay;

    document.addEventListener('DOMContentLoaded', function() {
      updateNavbar();
      updateThemeText();
      
      var searchInput = document.getElementById('search-input');
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          var query = this.value.toLowerCase();
          var results = document.getElementById('search-results');
          var currentLang = localStorage.getItem('site-lang') || 'zh';
          var t = translations[currentLang];
          
          if (!query || !searchData) {
            results.innerHTML = '';
            return;
          }
          
          var matches = searchData.filter(post => 
            post.lang === currentLang && 
            (post.title.toLowerCase().includes(query) || post.content.toLowerCase().includes(query))
          );
          
          if (matches.length === 0) {
            results.innerHTML = '<div class="no-results">' + t.no_results + '</div>';
          } else {
            results.innerHTML = matches.map(post => `
              <div class="search-result-item">
                <a href="${post.url}">${post.title}</a>
                <span class="post-meta">${post.date}</span>
              </div>
            `).join('');
          }
        });
      }
    });
  })();
</script>

<style>
.site-nav {
  line-height: 54px; /* Default header height for Minima */
}
.site-nav .trigger {
  display: block;
}
.site-nav .page-link {
  display: inline-block;
  margin-left: 20px !important;
  margin-right: 0 !important;
}
.lang-toggle-btn, .theme-toggle-btn {
  min-width: 45px;
  text-align: center;
}
.search-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  padding: 50px;
}
.search-overlay.active { display: block; }
.search-container {
  max-width: 800px;
  margin: 0 auto;
  background: var(--background-color, #fff);
  padding: 20px;
  border-radius: 8px;
}
html[data-theme="dark"] .search-container { background: #252525; color: #e0e0e0; }
.search-header { display: flex; align-items: center; margin-bottom: 20px; }
.search-input { flex: 1; padding: 10px; font-size: 1.2em; border: 1px solid #ccc; border-radius: 4px; }
.search-close { background: none; border: none; font-size: 2em; cursor: pointer; margin-left: 10px; color: inherit; }
.search-result-item { padding: 10px 0; border-bottom: 1px solid #eee; }
html[data-theme="dark"] .search-result-item { border-bottom-color: #3a3a3a; }
.search-result-item a { font-weight: bold; font-size: 1.1em; }
</style>
