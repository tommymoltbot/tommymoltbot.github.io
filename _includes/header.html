<header class="site-header" role="banner">

  <div class="wrapper">
    {%- assign default_paths = site.pages | map: "path" -%}
    {%- assign page_paths = site.header_pages | default: default_paths -%}
    <a class="site-title" rel="author" href="{{ "/" | relative_url }}">{{ site.title | escape }}</a>

    {%- if page_paths -%}
    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path
              d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger">
        <!-- About Link (translatable) - TEMPORARILY DISABLED
        <a class="page-link" id="about-link" href="{{ "/about/" | relative_url }}" data-i18n="about">About</a>
        -->

        <!-- Tags Link -->
        <a class="page-link" href="{{ "/tags/" | relative_url }}" data-i18n="tags">Ê®ôÁ±§</a>

        <!-- Language Switcher -->
        <a class="page-link lang-toggle-btn" href="#" id="lang-switcher" onclick="toggleLanguage(); return false;"
          title="Switch to English">
          <span id="lang-text">EN</span>
        </a>

        <!-- Dark Mode Toggle -->
        <a class="page-link theme-toggle-btn" href="#" id="theme-toggle" onclick="toggleTheme(); return false;"
          title="Toggle dark mode">
          <span id="theme-text">Dark</span>
        </a>

        <!-- Search Button -->
        <a class="page-link" href="#" id="search-toggle" onclick="openSearch(); return false;" title="Search">
          <span id="search-icon">üîç</span>
        </a>
      </div>
    </nav>
    {%- endif -%}
  </div>
</header>

<!-- Search Overlay -->
<div id="search-overlay" class="search-overlay" onclick="closeSearchOnOverlay(event)">
  <div class="search-container">
    <div class="search-header">
      <input type="text" id="search-input" class="search-input" data-i18n-placeholder="search_placeholder"
        placeholder="ÊêúÂ∞ãÊñáÁ´†..." autocomplete="off" />
      <button class="search-close" onclick="closeSearch()">&times;</button>
    </div>
    <div id="search-results" class="search-results"></div>
  </div>
</div>

<script>
  (function () {
    // Translation data
    var translations = {
      zh: {
        posts: "ÊñáÁ´†",
        about: "ÈóúÊñº",
        all_posts: "ÊâÄÊúâÊñáÁ´†",
        home: "È¶ñÈ†Å",
        prev_page: "‰∏ä‰∏ÄÈ†Å",
        next_page: "‰∏ã‰∏ÄÈ†Å",
        search_placeholder: "ÊêúÂ∞ãÊñáÁ´†Ê®ôÈ°åÊàñÂÖßÂÆπ...",
        no_results: "Êâæ‰∏çÂà∞Á¨¶ÂêàÁöÑÊñáÁ´†",
        search_hint: "Ëº∏ÂÖ•ÈóúÈçµÂ≠óÊêúÂ∞ã...",
        site_description: "",
        theme_dark: "Ê∑±Ëâ≤",
        theme_light: "Ê∑∫Ëâ≤",
        tags: "Ê®ôÁ±§",
        view_all_tags: "Êü•ÁúãÂÖ®ÈÉ®",
        tags_title: "Ê®ôÁ±§",
        all_tags: "ÂÖ®ÈÉ®"
      },
      en: {
        posts: "Posts",
        about: "About",
        all_posts: "All Posts",
        home: "Home",
        prev_page: "Previous",
        next_page: "Next",
        search_placeholder: "Search title or content...",
        no_results: "No matching posts found",
        search_hint: "Type to search...",
        site_description: "",
        theme_dark: "Dark",
        theme_light: "Light",
        tags: "Tags",
        view_all_tags: "View All",
        tags_title: "Tags",
        all_tags: "All"
      }
    };

    var searchData = null;
    var searchDataLoading = false;

    function toggleLanguage() {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var newLang = currentLang === 'zh' ? 'en' : 'zh';
      localStorage.setItem('site-lang', newLang);

      var path = window.location.pathname;

      // Check if on a post page (URL contains /zh/ or /en/)
      if (path.match(/^\/(zh|en)\//)) {
        var newPath = path.replace(/^\/(zh|en)\//, '/' + newLang + '/');
        window.location.href = newPath;
        return;
      }

      // Check if on About page - switch between /about/ and /about-zh/
      if (path.match(/^\/about\/?$/) || path.match(/^\/about-zh\/?$/)) {
        var newPath = newLang === 'zh' ? '/about-zh/' : '/about/';
        window.location.href = newPath;
        return;
      }

      // For other pages
      updateLangButton();
      updateNavbar();
      updateThemeText();
      filterPosts();
    }

    function updateLangButton() {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var btn = document.getElementById('lang-text');
      var langSwitcher = document.getElementById('lang-switcher');
      if (btn) {
        btn.textContent = currentLang === 'zh' ? 'EN' : '‰∏≠Êñá';
      }
      // Update tooltip to indicate what language will be switched to
      if (langSwitcher) {
        langSwitcher.title = currentLang === 'zh' ? 'Switch to English' : 'ÂàáÊèõËá≥‰∏≠Êñá';
      }
    }

    function updateNavbar() {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var t = translations[currentLang];

      // Update all elements with data-i18n attribute
      var elements = document.querySelectorAll('[data-i18n]');
      elements.forEach(function (el) {
        var key = el.getAttribute('data-i18n');
        if (t[key]) {
          el.textContent = t[key];
        }
      });

      // Update placeholders
      var placeholderElements = document.querySelectorAll('[data-i18n-placeholder]');
      placeholderElements.forEach(function (el) {
        var key = el.getAttribute('data-i18n-placeholder');
        if (t[key]) {
          el.placeholder = t[key];
        }
      });

      // Update About link href based on language
      var aboutLink = document.getElementById('about-link');
      if (aboutLink) {
        aboutLink.href = currentLang === 'zh' ? '/about-zh/' : '/about/';
      }

      // Update post list heading
      var postHeading = document.querySelector('.post-list-heading');
      if (postHeading) {
        postHeading.textContent = t.posts;
      }
    }

    function filterPosts() {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      
      // Update the dynamically injected CSS rule (from custom-head.html)
      var langStyle = document.getElementById('lang-filter-style');
      if (langStyle) {
        langStyle.textContent = '#post-list [data-lang]:not([data-lang="' + currentLang + '"]) { display: none !important; }';
      }
      
      // Also update inline styles for immediate effect
      var posts = document.querySelectorAll('#post-list [data-lang]');
      posts.forEach(function (post) {
        var postLang = post.dataset.lang;
        if (postLang === currentLang) {
          post.style.display = '';
        } else {
          post.style.display = 'none';
        }
      });
    }

    // Dark mode functions
    function toggleTheme() {
      // Read current theme from DOM to ensure sync
      var currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      var newTheme = currentTheme === 'light' ? 'dark' : 'light';
      localStorage.setItem('site-theme', newTheme);
      applyTheme(newTheme);
      updateThemeText();
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
    }

    function updateThemeText() {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
      var t = translations[currentLang];
      var themeText = document.getElementById('theme-text');
      if (themeText) {
        // Show the opposite theme name (what clicking will switch to)
        themeText.textContent = currentTheme === 'light' ? t.theme_dark : t.theme_light;
      }
    }

    function initTheme() {
      // Theme is already applied by the blocking script in custom-head.html
      // This function now only handles system preference changes
      var savedTheme = localStorage.getItem('site-theme');
      if (!savedTheme) {
        // Check system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          savedTheme = 'dark';
        } else {
          savedTheme = 'light';
        }
        localStorage.setItem('site-theme', savedTheme);
      }
      applyTheme(savedTheme);
    }

    // ===== Full-screen Search Functions =====
    function loadSearchData(callback) {
      if (searchData) {
        callback(searchData);
        return;
      }
      if (searchDataLoading) {
        setTimeout(function () { loadSearchData(callback); }, 100);
        return;
      }
      searchDataLoading = true;
      fetch('/search.json')
        .then(function (response) { return response.json(); })
        .then(function (data) {
          searchData = data;
          searchDataLoading = false;
          callback(data);
        })
        .catch(function (err) {
          console.error('Failed to load search data:', err);
          searchDataLoading = false;
        });
    }

    function openSearch() {
      var overlay = document.getElementById('search-overlay');
      var input = document.getElementById('search-input');
      var results = document.getElementById('search-results');

      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';

      // Show hint message
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var t = translations[currentLang];
      results.innerHTML = '<div class="search-hint">' + t.search_hint + '</div>';

      // Focus input after animation
      setTimeout(function () {
        input.focus();
      }, 100);

      // Preload search data
      loadSearchData(function () { });
    }

    function closeSearch() {
      var overlay = document.getElementById('search-overlay');
      var input = document.getElementById('search-input');
      var results = document.getElementById('search-results');

      overlay.classList.remove('active');
      document.body.style.overflow = '';
      input.value = '';
      results.innerHTML = '';
    }

    function closeSearchOnOverlay(event) {
      if (event.target.id === 'search-overlay') {
        closeSearch();
      }
    }

    function performSearch(query) {
      var currentLang = localStorage.getItem('site-lang') || 'zh';
      var t = translations[currentLang];
      var results = document.getElementById('search-results');

      if (!query.trim()) {
        results.innerHTML = '<div class="search-hint">' + t.search_hint + '</div>';
        return;
      }

      loadSearchData(function (data) {
        var searchTerm = query.toLowerCase().trim();
        var matches = [];

        data.forEach(function (post) {
          if (post.lang !== currentLang) return;

          var titleMatch = post.title.toLowerCase().indexOf(searchTerm) !== -1;
          var contentMatch = post.content.toLowerCase().indexOf(searchTerm) !== -1;

          if (titleMatch || contentMatch) {
            var snippet = '';
            if (contentMatch) {
              var contentLower = post.content.toLowerCase();
              var idx = contentLower.indexOf(searchTerm);
              var start = Math.max(0, idx - 50);
              var end = Math.min(post.content.length, idx + searchTerm.length + 100);
              snippet = (start > 0 ? '...' : '') + post.content.substring(start, end) + (end < post.content.length ? '...' : '');
              // Highlight the search term
              snippet = highlightText(snippet, searchTerm);
            }

            matches.push({
              title: highlightText(post.title, searchTerm),
              url: post.url,
              date: post.date,
              snippet: snippet,
              titleMatch: titleMatch
            });
          }
        });

        // Sort: title matches first
        matches.sort(function (a, b) {
          if (a.titleMatch && !b.titleMatch) return -1;
          if (!a.titleMatch && b.titleMatch) return 1;
          return 0;
        });

        if (matches.length === 0) {
          results.innerHTML = '<div class="no-results">' + t.no_results + '</div>';
          return;
        }

        var html = '<ul class="search-results-list">';
        matches.forEach(function (match) {
          html += '<li class="search-result-item">';
          html += '<a href="' + match.url + '" class="search-result-link">';
          html += '<span class="search-result-title">' + match.title + '</span>';
          html += '<span class="search-result-date">' + match.date + '</span>';
          if (match.snippet) {
            html += '<p class="search-result-snippet">' + match.snippet + '</p>';
          }
          html += '</a></li>';
        });
        html += '</ul>';
        results.innerHTML = html;
      });
    }

    function highlightText(text, term) {
      if (!term) return text;
      var regex = new RegExp('(' + term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    function initSearch() {
      var searchInput = document.getElementById('search-input');
      if (searchInput) {
        var debounceTimer;
        searchInput.addEventListener('input', function () {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(function () {
            performSearch(searchInput.value);
          }, 200);
        });
      }

      // ESC key to close
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          var overlay = document.getElementById('search-overlay');
          if (overlay && overlay.classList.contains('active')) {
            closeSearch();
          }
        }
      });
    }

    // Expose to global scope for onclick
    window.toggleLanguage = toggleLanguage;
    window.toggleTheme = toggleTheme;
    window.openSearch = openSearch;
    window.closeSearch = closeSearch;
    window.closeSearchOnOverlay = closeSearchOnOverlay;

    // Run on DOM load
    function init() {
      initTheme();
      updateLangButton();
      updateNavbar();
      updateThemeText();
      filterPosts();
      initSearch();
      
      // Remove loading class to reveal elements that were hidden during load
      document.documentElement.classList.remove('site-loading');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>